# eShopFlix Microservices - Docker Compose
# Run from solution root: docker-compose up -d

version: '3.8'

services:
  # ===========================================
  # Infrastructure Services
  # ===========================================
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: eshopflix-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrong@Passw0rd
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - eshopflix-network
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong@Passw0rd" -C -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ===========================================
  # Backend Microservices
  # ===========================================
  catalog-service:
    image: ${DOCKER_REGISTRY-}catalogservice
    container_name: eshopflix-catalog
    build:
      context: .
      dockerfile: BackendServices/CatalogService/CatalogService.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=CatalogDb;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
    ports:
      - "5001:8080"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - eshopflix-network
    restart: on-failure

  auth-service:
    image: ${DOCKER_REGISTRY-}authservice
    container_name: eshopflix-auth
    build:
      context: .
      dockerfile: BackendServices/AuthService/AuthService.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=AuthDb;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
    ports:
      - "5002:8080"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - eshopflix-network
    restart: on-failure

  cart-service:
    image: ${DOCKER_REGISTRY-}cartservice
    container_name: eshopflix-cart
    build:
      context: .
      dockerfile: BackendServices/CartService/CartService.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=CartDb;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
    ports:
      - "5003:8080"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - eshopflix-network
    restart: on-failure

  payment-service:
    image: ${DOCKER_REGISTRY-}paymentservice
    container_name: eshopflix-payment
    build:
      context: .
      dockerfile: BackendServices/PaymentService/PaymentService.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=PaymentDb;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
      - RazorPay__Key=${RAZORPAY_KEY}
      - RazorPay__Secret=${RAZORPAY_SECRET}
    ports:
      - "5004:8080"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - eshopflix-network
    restart: on-failure

  order-service:
    image: ${DOCKER_REGISTRY-}orderservice
    container_name: eshopflix-order
    build:
      context: .
      dockerfile: BackendServices/OrderService/OrderService.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=OrderDb;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
    ports:
      - "5005:8080"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - eshopflix-network
    restart: on-failure

  stock-service:
    image: ${DOCKER_REGISTRY-}stockservice
    container_name: eshopflix-stock
    build:
      context: .
      dockerfile: BackendServices/StockService/StockService.API/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=StockDb;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
    ports:
      - "5006:8080"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - eshopflix-network
    restart: on-failure

  # ===========================================
  # API Gateway
  # ===========================================
  api-gateway:
    image: ${DOCKER_REGISTRY-}apigateway
    container_name: eshopflix-gateway
    build:
      context: .
      dockerfile: ApiGateways/OcelotApiGateway/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
    ports:
      - "5000:8080"
    depends_on:
      - catalog-service
      - auth-service
      - cart-service
      - payment-service
      - order-service
      - stock-service
    networks:
      - eshopflix-network
    restart: on-failure

  # ===========================================
  # Frontend Web Application
  # ===========================================
  web-app:
    image: ${DOCKER_REGISTRY-}eshopflixweb
    container_name: eshopflix-web
    build:
      context: .
      dockerfile: FrontendServices/eShopFlix.Web/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - ApiGateway__BaseUrl=http://api-gateway:8080
    ports:
      - "5010:8080"
    depends_on:
      - api-gateway
    networks:
      - eshopflix-network
    restart: on-failure

# ===========================================
# Networks
# ===========================================
networks:
  eshopflix-network:
    driver: bridge
    name: eshopflix-network

# ===========================================
# Volumes
# ===========================================
volumes:
  sqlserver-data:
    name: eshopflix-sqlserver-data
